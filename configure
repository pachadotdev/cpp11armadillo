#!/bin/sh

# We make sure that the R and Armadillo bindings are compatible (i.e., messages)
# this is why we add the R and cpp11 path
CXX=`${R_HOME}/bin/R CMD config CXX`
R_INCLUDE_PATH=`${R_HOME}/bin/R CMD config --cflags`
R_INCLUDE_DIR=`${R_HOME}/bin/R CMD config --ldflags | sed 's/-L[^ ]*//g' | sed 's/-lR//g'`
CPP11_INCLUDE_PATH=`${R_HOME}/bin/Rscript -e "cat(system.file('include', package = 'cpp11'))"`

# Check if CPP11_INCLUDE_PATH is empty
if [ -z "$CPP11_INCLUDE_PATH" ]; then
  echo "Error: cpp11 include path is empty. Please ensure the cpp11 package is installed."
  exit 1
fi

# Manually specify the R include path if --cflags does not provide it
if [ "$R_INCLUDE_PATH" = "ERROR: no information for variable '--cflags'" ]; then
  R_INCLUDE_PATH="-I/usr/share/R/include"
fi

PKG_CFLAGS="-I./inst/include ${R_INCLUDE_PATH} -I${R_INCLUDE_DIR} -I${CPP11_INCLUDE_PATH}"

# Debugging: Print the values of the variables
echo "CXX: ${CXX}"
echo "R_INCLUDE_PATH: ${R_INCLUDE_PATH}"
echo "R_INCLUDE_DIR: ${R_INCLUDE_DIR}"
echo "CPP11_INCLUDE_PATH: ${CPP11_INCLUDE_PATH}"
echo "PKG_CFLAGS: ${PKG_CFLAGS}"

# Create a temporary C++ file to test the compatibility with Armadillo
cat <<EOF> conftest.cpp
#include <armadillo.hpp>
using namespace arma;
int main() {
  Mat<int> A(2, 2, fill::ones);
  return 0;
}
EOF

# Test Armadillo
if ! ${CXX} -c conftest.cpp -o conftest.o ${PKG_CFLAGS}
then
  echo "Armadillo is not compatible with the C++ compiler used by R."
  rm -rf conftest.cpp conftest.o
  exit 1
else
  echo "Armadillo is compatible with the C++ compiler used by R."
  rm -rf conftest.cpp conftest.o
fi
